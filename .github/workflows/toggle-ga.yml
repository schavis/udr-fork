name: ‚úÖ Create GA PR
run-name: Create GA PR [${{ github.actor }}]

permissions: 
  pull-requests: write

on: 
  workflow_dispatch:
    inputs:
      targetVersion:
        required: true
        description: Preview version (e.g., "1.21.x")
      folderTag:
        required: true
        default: 'rc'
        description: Preview dog tag ('rc' or 'beta')
      product:
        required: true
        description: Product slug

env:
  prBranch: "${{ github.event.inputs.product }}/${{ github.event.inputs.targetVersion }}-to-ga"
  oldFolder: "content/${{ github.event.inputs.product }}/v${{ github.event.inputs.targetVersion }} (${{ github.event.inputs.folderTag }})"
  newFolder: "content/${{ github.event.inputs.product }}/v${{ github.event.inputs.targetVersion }}"


jobs:

  create-branch:
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN:   ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Check out main
        uses: actions/checkout@v4

      - name: Create PR branch
        id: create-branch
        uses: peterjgrainger/action-create-branch@v2.2.0
        with:
          branch: "refs/heads/${{ github.env.prBranch }}"

  update-folder:
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN:   ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Check out PR branch (${{ github.env.prBranch }})
        uses: actions/checkout@v4
        with:
          ref: "refs/heads/${{ github.env.prBranch }}"

      - name: Update folder name
        run: |
          mv "${{ github.env.oldFolder }}" "${{ github.env.newFolder }}"

      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Remove preview tag from v${{ github.event.inputs.targetVersion }}.x"
          branch: ${{ github.env.prBranch }}

  create-pr:
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN:   ${{ secrets.GITHUB_TOKEN }}
      prTitle:     "[PUBLISH GA] Mark ${{ github.event.inputs.targetVersion }} GA"
      prBody: |
        üöß \`${{ github.repository }}\` publication PR

        **Triggered by**: @${{ github.actor }} with a Github action
        **Preview folder**: \`${{ github.event.inputs.releaseBranch }}\`
        **New folder**:   \`${{ github.event.inputs.mergeTarget }}\`
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.env.prBranch }}
          fetch-depth: 0
      - name: Create pull request
        run: |
          gh pr create                          \
            --base  main                        \
            --head  ${{ github.env.prBranch }}  \
            --title "${{ env.prTitle }}"        \
            --body  "${{ env.prBody }}"
      - name: Wrap-up
        run: |
          echo "üçè Final job status:  ${{ job.status }}"
