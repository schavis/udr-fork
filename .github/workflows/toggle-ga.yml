name: ‚úÖ Create GA PR
run-name: Create GA PR [${{ github.actor }}]

permissions: 
  pull-requests: write
  contents: write

on: 
  workflow_dispatch:
    inputs:
      targetVersion:
        required: true
        description: Preview version (e.g., "1.21.x")
        default: '1.21.x'
      folderTag:
        required: true
        default: 'rc'
        description: Preview dog tag ('rc' or 'beta')
      product:
        required: true
        default: 'vault'
        description: Product slug

env:
  prBranch: "${{ github.event.inputs.product }}/${{ github.event.inputs.targetVersion }}-to-ga"
  oldFolder: "v${{ github.event.inputs.targetVersion }} (${{ github.event.inputs.folderTag }})"
  newFolder: "v${{ github.event.inputs.targetVersion }}"


jobs:

  update-folder:
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN:   ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Check out main
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Update preview folder
        working-directory: ./content/${{ github.event.inputs.product }}
        run: |
          git pull
          git checkout -B "${{ env.prBranch }}"
          mv "./${{ env.oldFolder }}" "./${{ env.newFolder }}"
      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Remove preview tag from ${{ env.oldFolder }}"
          branch: ${{ env.prBranch }}

  create-pr:
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN:   ${{ secrets.GITHUB_TOKEN }}
      prTitle:     "[PUBLISH GA] Convert ${{ github.event.inputs.targetVersion }} to GA"
      prBody: |
        üöß \`${{ github.repository }}\` publication PR

        **Triggered by**: @${{ github.actor }} with a Github action
        **Preview folder**: \`${{ github.event.inputs.product }}/v${{ github.event.inputs.targetVersion }} (${{ github.event.inputs.folderTag }})\`
        **New folder**:   \`${{ github.event.inputs.product }}/v${{ github.event.inputs.targetVersion }}\`
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4
        with:
          ref: ${{ env.prBranch }}
          fetch-depth: 0
      - name: Create pull request
        run: |
          gh pr create                    \
            --base  main                  \
            --head  ${{ env.prBranch }}   \
            --title "${{ env.prTitle }}"  \
            --body  "${{ env.prBody }}"
      - name: Wrap-up
        run: |
          echo "üçè Final job status:  ${{ job.status }}"
