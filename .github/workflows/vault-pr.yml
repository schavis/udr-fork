# Add comments to Vault PRs with a reminder about release branches
# github.base_ref (target)
# github.head_ref (source)

name: Process Vault PR
run-name: üöÄ Processing Vault PR

on: [pull_request_target]

env:
  yes: ‚úîÔ∏è
  no: ‚ùå
  idk: ‚èπÔ∏è
  pub_comment: |
    ## üïõ Publication timeline
    
    Content changes publish based on the merge target
    
    | Branch            | Publication timeline  | Selection
    | ----------------- | --------------------- | ---------

  main_entry: "| `main`            | Immediately           |"
  monthly_entry: "| `vault/YYYYMM`    | End of the month      |"
  release_entry: "| `vault/<version>` | Next major release    |"

jobs:

  add-pub-comment:
    name: Add release comment
    runs-on: ubuntu-latest
    steps:
      - name: Initial comment on PR
        uses: marocchino/sticky-pull-request-comment@52423e01640425a022ef5fd42c6fb5f633a02728 # v2.9.1
        with:
          repo-token: "${{ secrets.GITHUB_TOKEN }}"
          header: Publication notice [${{ github.base_ref }}]
          message: |
            ${{ env.pub_comment }}
            ${{ env.main_entry }} ${{ env.idk }}
            ${{ env.monthly_entry }} ${{ env.idk }}
            ${{ env.release_entry }} ${{ env.idk }}

  update-pub-comment:
    name: Update with pb
    runs-on: ubuntu-latest
    steps:
      - name: PR publishes immediately
        if: ${{ github.base_ref }} == "refs/head/main"
        uses: marocchino/sticky-pull-request-comment@52423e01640425a022ef5fd42c6fb5f633a02728 # v2.9.1
        with:
          header: Publication notice
          message: |
            ${{ env.pub_comment }}
            ${{ env.main_entry }} ${{ env.yes }}
            ${{ env.monthly_entry }} ${{ env.no }}
            ${{ env.release_entry }} ${{ env.no }}

      - name: PR publishes with monthly release
        if: ${{ github.base_ref }} ~= "vault/[0-9]{6}"
        uses: marocchino/sticky-pull-request-comment@52423e01640425a022ef5fd42c6fb5f633a02728 # v2.9.1
        with:
          header: Publication notice
          message: |
            ${{ env.pub_comment }}
            ${{ env.main_entry }} ${{ env.no }}
            ${{ env.monthly_entry }} ${{ env.yes }}
            ${{ env.release_entry }} ${{ env.no }}

      - name: PR publishes with next major release
        if: ${{ github.base_ref }} ~= "vault/[0-9]\\.[0-9]{2}\\.x"
        uses: marocchino/sticky-pull-request-comment@52423e01640425a022ef5fd42c6fb5f633a02728 # v2.9.1
        with:
          header: Publication notice
          message: |
            ${{ env.pub_comment }}
            ${{ env.main_entry }} ${{ env.no }}
            ${{ env.monthly_entry }} ${{ env.no }}
            ${{ env.release_entry }} ${{ env.yes }}
